<?xml version="1.0" encoding="UTF-8" ?>
<project name="maven-ant-tasks" default="setup-elk" basedir=".">

	<property name="elk.dist" value="target/dist/elk"/>
	<property name="zeppelin-solr-version" value="0.1.6"/>


	<!-- Right now we use ELK (Elasticsearch - Logstash - Kibana stack) only for Debian distribution of Datafari -->
	<target name="setup-elk">
		<!-- *** Setup Logstash *** -->

		<!-- We unzip and untar Logstash here instead of Maven's plugin Wget (like done for the other components)
				 as it doesn't handle correctly duplicated directory names in the path: e.g. A/B/C/B/D -->
		<untar dest="${elk.dist}/logstash" compression="gzip">
			<fileset dir="target">
				<include name="*logstash*.tar.gz" />
			</fileset>
			<cutdirsmapper dirs="1" />
		</untar>
		
		<!-- Copy Datafari-specific directories and files for ELK -->
		<copy toDir="${elk.dist}" overwrite="true" force="true">
			<fileset dir="." >
				<include name="logstash/**" />
				<include name="scripts/**" />
			</fileset>
		</copy>

		<!-- *** Setup elk-manager.sh *** -->
		<replace file="${elk.dist}/scripts/elk-manager.sh" token="@ADDITIONAL_LOGSTASH_INIT@" value=""/>
		<replace file="${elk.dist}/scripts/elk-manager.sh" token="@ADDITIONAL_FUNCTIONS@" value=""/>

		<!-- *** Setup logstash-datafari.conf *** -->
		<replace file="${elk.dist}/logstash/logstash-datafari.conf" token="@ADDITIONAL_INPUTS@" value=""/>
		<replace file="${elk.dist}/logstash/logstash-datafari.conf" token="@ADDITIONAL_FILTERS@" value=""/>
		<replace file="${elk.dist}/logstash/logstash-datafari.conf" token="@ADDITIONAL_OUTPUTS@" value=""/>
		
		<!-- Untar zeppelin -->
		<untar dest="${elk.dist}/zeppelin" compression="gzip">
      <fileset dir="target">
        <include name="zeppelin*" />
      </fileset>
      <cutdirsmapper dirs="1" />
    </untar>
		
		<!-- Remove Zeppelin Default Notebooks -->
		<delete includeemptydirs="true">
      <fileset dir="${elk.dist}/zeppelin/notebook"> 
        <include name="**/*"/>
      </fileset>
    </delete>
		
		<!-- Remove Zeppelin Unused Interpreters -->
    <delete includeemptydirs="true">
      <fileset dir="${elk.dist}/zeppelin/interpreter"> 
        <include name="**/*"/>
      	<exclude name="*.jar"/>
      </fileset>
    </delete>
		
		<!-- Install Zeppelin Solr Interpreter -->
    <exec executable="/bin/bash">
      <arg value="${elk.dist}/zeppelin/bin/install-interpreter.sh"/>
      <arg value="--name solr --artifact com.lucidworks.zeppelin:zeppelin-solr:${zeppelin-solr-version}"/>
    </exec>
		
		<!-- Copy Datafari specific Zeppelin files -->
		<copy toDir="${elk.dist}" overwrite="true" force="true">
      <fileset dir="." >
        <include name="zeppelin/**" />
      </fileset>
    </copy>
		
		<!-- Delete tar.gz and tgz files -->
    <delete>
      <fileset dir="target"> 
        <include name="*.tar.gz"/>
      	<include name="*.tgz"/>
      </fileset>
    </delete>

	</target>



</project>
