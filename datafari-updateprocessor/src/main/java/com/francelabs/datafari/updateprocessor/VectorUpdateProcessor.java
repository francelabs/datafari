/*******************************************************************************
 /*******************************************************************************
 *  * Copyright 2020 France Labs
 *  *
 *  * Licensed under the Apache License, Version 2.0 (the "License");
 *  * you may not use this file except in compliance with the License.
 *  * You may obtain a copy of the License at
 *  *
 *  *      http://www.apache.org/licenses/LICENSE-2.0
 *  *
 *  * Unless required by applicable law or agreed to in writing, software
 *  * distributed under the License is distributed on an "AS IS" BASIS,
 *  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  * See the License for the specific language governing permissions and
 *  * limitations under the License.
 *******************************************************************************/
package com.francelabs.datafari.updateprocessor;

import java.io.IOException;

import java.util.Arrays;
import java.util.List;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import dev.langchain4j.data.document.Document;
import dev.langchain4j.data.document.DocumentSplitter;
import dev.langchain4j.data.document.splitter.DocumentByParagraphSplitter;

import dev.langchain4j.data.segment.TextSegment;


import dev.langchain4j.model.Tokenizer;
import dev.langchain4j.model.openai.OpenAiTokenizer;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.apache.solr.client.solrj.SolrServerException;
import org.apache.solr.client.solrj.impl.CloudSolrClient;
import org.apache.solr.common.SolrInputDocument;
import org.apache.solr.common.SolrInputField;
import org.apache.solr.common.params.SolrParams;
import org.apache.solr.update.AddUpdateCommand;
import org.apache.solr.update.DeleteUpdateCommand;
import org.apache.solr.update.processor.UpdateRequestProcessor;
import org.json.simple.JSONArray;
import org.json.simple.JSONObject;

public class VectorUpdateProcessor extends UpdateRequestProcessor {
  private static final Logger LOGGER = LogManager.getLogger(VectorUpdateProcessor.class.getName());
  boolean enabled = false;
  CloudSolrClient client;

  private static final int CHUNK_SIZE = 4000;
  private static final int MAX_OVERLAP_SIZE = 100;
  private static final int VECTOR_DIMENSION = 4;

  public VectorUpdateProcessor(CloudSolrClient client, final SolrParams params, final UpdateRequestProcessor next) {
    super(next);
    if (params != null) {
      this.enabled = params.getBool("enabled", false);
      this.client = client;
    }
  }

  @Override
  public void processAdd(final AddUpdateCommand cmd) throws IOException {
    if (enabled) {
      final SolrInputDocument parentDoc = cmd.getSolrInputDocument();

      String content = "";
      String parentId = (String) parentDoc.get("id").getValue();
      final SolrInputField contentFieldFr = parentDoc.get("content_fr");
      final SolrInputField contentFieldEn = parentDoc.get("content_en");
      if (contentFieldFr != null) {
        content = (String) contentFieldFr.getFirstValue();
      } else if (contentFieldEn != null) {
        content = (String) contentFieldEn.getFirstValue();
      }

      deleteExistingChildren(parentId);

      if (content != null && !content.isEmpty()) {

        // Chunking
        Tokenizer tokenizer = new OpenAiTokenizer();
        DocumentSplitter splitter = new DocumentByParagraphSplitter(CHUNK_SIZE, MAX_OVERLAP_SIZE, tokenizer);
        Document document = new Document(content);
        List<TextSegment> chunks = splitter.split(document);

        LOGGER.info("EBE - Nombre de chunks : {}",  chunks.size());

        for (TextSegment chunk : chunks) {
          LOGGER.info("EBE - Nombre de chunks pour {} : {}", parentId,  chunks.size());
          // TODO : remove
          LOGGER.info("EBE - Taille du chunk {} pour {} : {}", chunks.indexOf(chunk), parentId, chunk.text().length());
          try {
            LOGGER.info("EBE - Chunk {}_{} : {}", parentId, chunks.indexOf(chunk), chunk.text().substring(0, 50).replaceAll("[\r\n]+", ""));
          } catch (Exception e) {
            LOGGER.info("EBE - Chunk {}_{} : {}", parentId, chunks.indexOf(chunk), chunk.text().substring(0, 2));
          }
        }

        for (TextSegment chunk : chunks) {
          if(chunk != null && !chunk.text().isEmpty()) {

            // Vector embeddings
            List<Float> vector = vectorEmbeddings(chunk.text());

            // Sub-document creation
            if (chunk.text() != null && vector.size() == VECTOR_DIMENSION) {

              SolrInputDocument vectorDocument = parentDoc.deepCopy();
              String vectorField = "vector_1536";

              List<Float> floatvector =  Arrays.asList(0.0014664384F, 0.05960067F, 0.032785796F, -0.061771914F, 0.034115683F, 0.0036164797F, -0.055800993F, -0.00943813F, -0.04828306F, 0.022784501F, -0.003677546F, -0.040358014F,
                      -0.0034383698F, -0.035635557F, 0.041117948F, 0.037101146F, -0.048744448F, 0.007395803F, -0.024440074F, 0.046817467F, 0.039978046F, 0.01648789F, -0.011052993F, 0.0300446F, -0.015361558F, 0.027371256F,
                      0.004756383F, 0.053494044F, 0.035716977F, -0.017207116F, 0.06475738F, -0.043424897F, 0.016610023F, -0.021997424F, -0.0036368351F, -0.03674832F, 0.012613576F, -0.0025868346F, 0.0045697917F, -0.004183039F,
                      0.005631666F, 0.014778036F, 0.023856552F, -0.039489515F, -0.064648814F, 0.018482722F, 0.024996456F, -0.0031771418F, 0.03539129F, 0.034061402F, 0.0020915195F, 0.0035147027F, -0.028497588F, 0.05550245F,
                      -0.04410341F, -0.050562866F, -0.02418224F, 0.007904688F, 0.024127958F, -0.041959308F, 0.023910834F, 0.00579451F, 0.011392251F, -0.006764785F, -0.0071447524F, 0.06654865F, -0.053141218F, 0.001838773F,
                      0.00508207F, 0.0010839262F, -0.035988383F, 0.011894351F, 0.011880781F, -0.034658495F, 0.010530538F, -0.044619083F, 0.018862689F, -0.01158902F, -0.047251716F, -0.017709216F, -0.029393228F, -0.016243625F,
                      -0.03536415F, 0.01931051F, 0.06486594F, -0.057809394F, -0.035988383F, 0.051268518F, -0.028796135F, 0.0024324728F, 0.014113092F, -0.07365948F, -0.014601622F, -0.020436842F, 0.062369008F, -0.0069072726F,
                      -0.0009338049F, -0.020599686F, -0.032704376F, -0.0107340915F, 0.06660294F, -0.058243643F, -0.028443307F, -0.030831676F, 0.039109547F, 0.027520528F, 0.015592252F, 0.0036809386F, -0.023327312F, -0.02511859F, -0.096023306F, 0.017763497F, 0.016745726F, 0.018998392F, 0.018604854F, 0.05482393F, 0.007395803F, -0.0023001626F, 0.025864955F, -0.034142826F, -0.045813266F, 0.0016157115F, 0.0012281104F, 0.045731846F, 0.026570609F, 0.014859457F, 0.0589493F, -0.023313742F, -0.046166092F, -0.0016835629F, 0.020721817F, -0.018360589F, -0.0013061395F, -0.04163362F, -0.017057842F, -0.0531955F, -0.024032967F, 0.012633931F, -0.0052211653F, 0.023463015F, 0.040737983F, 0.004135543F, 0.022472383F, 0.011650085F, -0.027615521F, 0.0056079184F, 0.01841487F, 0.009614544F, -0.0251593F, 0.0098588085F, -0.03875672F, -0.015239425F, 0.035472713F, -0.0018591284F, 0.012247178F, -0.049640086F, 0.006225366F, 0.060740575F, -0.003582554F, 0.0083592925F, 0.009505982F, 0.0020983047F, 0.016813578F, -0.0018014547F, -0.03395284F, -0.042827804F, -0.015429408F, -0.0008880052F, -0.024589349F, 0.015714385F, 0.033762857F, -0.015863657F, 0.03294864F, 0.010075933F, -0.021373192F, 0.0040337658F, -0.007884333F, 0.041470777F, -0.007796126F, -0.024195809F, 0.008834252F, 0.01939193F, -0.012905337F, -0.030397428F, -0.013570281F, 0.012484658F, -0.04502619F, -0.0060625225F, -0.015605822F, 0.011514382F, -0.008562847F, -0.035472713F, 0.07045689F, -0.003653798F, 0.021020364F, 0.021685308F, 0.06264041F, -0.036069807F, -0.020056874F, 0.004915834F, 0.023055905F, 0.01937836F, 0.044809066F, -0.030288866F, 0.079630405F, 0.041416496F, -0.016297907F, 0.022377392F, -0.0055434597F, -0.00024320486F, 0.039408095F, -0.00020906713F, -0.039353814F, -0.0020168829F, -0.045569003F, 0.03856674F, -0.07821909F, -0.005587563F, -0.0033433777F, 0.021400332F, 0.011575449F, 0.027208412F, 0.0122336075F, 0.028253324F, 0.044863347F, 0.0005568056F, 0.027140561F, -0.023137327F, 0.015727954F, 0.02758838F, 0.00484459F, 0.004373023F, -0.0386753F, -0.06367175F, -0.040819403F, 0.012186112F, -0.005129566F, 0.014927308F, -0.004932797F, -0.043696303F, -0.011310829F, 0.022852352F, -0.035581276F, -0.012301459F, -0.026434906F, -0.028687572F, -0.0025342498F, -0.030126022F, 0.049694367F, 0.011473672F, 0.098357394F, -0.0033060596F, 0.017559942F, -0.01285784F, -0.02806334F, -0.0036402277F, -0.03976092F, -0.018631995F, 0.014615192F, -0.0017726179F, 0.021576745F, -0.018550573F, -0.04833734F, -0.0028735069F, 0.040358014F, 0.028714713F, -0.018862689F, 0.0021373192F, -0.008589988F, -0.023761561F, 0.0084475F, -0.016840719F, 0.014153803F, -0.015768666F, -0.01067981F, -0.046274655F, -0.006133767F, 0.039516658F, -0.0047360277F, -0.0015783933F, -0.009967371F, 0.034278527F, 0.019432642F, -0.021196777F, 0.004427304F, 0.04372344F, 0.030560272F, -0.027032F, 0.03718257F, -0.0034332809F, -0.020423273F, 0.0045290813F, 0.028171903F, -0.025824243F, 0.006306788F, -0.024019396F, 0.009017452F, 0.019649766F, -0.0012900247F, -0.0060184193F, 0.0066256896F, 0.03161875F, -0.01086301F, -0.021020364F, -0.02760195F, 0.008827467F, -0.016881429F, -0.027466247F, 0.016325047F, 0.0070429756F, 0.06627725F, -0.039299533F, -0.016569313F, -0.033762857F, 0.001690348F, -0.04850018F, 0.028199043F, -0.0018082398F, 0.075722165F, -0.014778036F, -0.0015427712F, 0.009852024F, -0.02081681F, 0.065517314F, 0.0040235883F, -0.08370149F, 0.011093704F, -0.024806472F, -0.05327692F, -0.030560272F, 0.00037890766F, -0.05229986F, -0.041932166F, 0.0647031F, -0.061826196F, 0.010245562F, 0.03775252F, 0.017356388F, 0.059329264F, 0.03536415F, 0.010218421F, -0.03134735F, -0.036666896F, -0.02183458F, -0.015076581F, -0.0049599377F, 0.0160265F, -0.027045568F, -0.010951216F, 0.041796464F, -0.018631995F, 0.007687564F, -0.012667857F, -0.0133328F, -0.053792592F, -0.037481114F, 0.042800665F, -0.023802271F, -0.016135063F, 0.029148962F, -0.047251716F, -0.030288866F, 0.034169964F, -0.0073686624F, 0.005387401F, -0.008413574F, -0.017288538F, 0.033545732F, -0.014167373F, -0.008657839F, -0.0020915195F, 0.03777966F, -0.0024019396F, -0.015239425F, 0.011521168F, 0.033600014F, 0.0133802965F, 0.0068937023F, 0.0031381273F, 0.024453646F, -0.010639099F, 0.01746495F, 0.016270766F, -0.0019422463F, 0.039842345F, -0.003731827F, -0.05083427F, 0.053222638F, 0.007823267F, -0.019025533F, 0.011120845F, -0.022282401F, -0.012294674F, 0.020138295F, -0.011466887F, -0.01450663F, 0.026842015F, 0.016257197F, 0.030397428F, -0.020531835F, -0.0098384535F, -0.002898951F, -0.011141201F, -0.07045689F, -0.0025393388F, -0.0010627225F, -0.054552525F, -0.02374799F, -0.07697063F, -0.033708576F, -0.005160099F, -0.006646045F, 0.012891767F, -0.0052754465F, -0.02511859F, -0.053086936F, -0.001659815F, -0.021603886F, 0.009818098F, -0.014330216F, -0.056452367F, -0.04445624F, 0.04510761F, -0.045867547F, -0.008746046F, 0.032242987F, 0.017451381F, 0.008983525F, 0.058352206F, -0.016365757F, -0.051485643F, 0.01736996F, -0.018184176F, 0.0052890168F, 0.0031160756F, -0.040439434F, -0.00160723F, -0.027208412F, 0.0013349763F, 0.014180943F, 0.050481442F, 0.00702262F, 0.034034263F, 0.0100148665F, -0.014262364F, 0.028470447F, 0.000279675F, 0.026923437F, 0.035201307F, -0.0010907113F, -0.014859457F, -0.02317804F, -0.01308175F, -0.0006632474F, -0.007640068F, 0.015551541F, -0.010727307F, 0.052055594F, -0.003445155F, -0.03824105F, -0.0061914404F, -0.022675939F, 0.018726988F, 0.05083427F, -0.017749926F, 0.03047885F, -0.03677546F, 0.03826819F, 0.048961572F, 0.046084672F, 0.033220045F, 0.028253324F, -0.009594188F, 0.013136031F, 0.0077214893F, 0.012667857F, -0.027262693F, 0.020871092F, 0.013298875F, 0.037426833F, 0.014968019F, -0.060360607F, -0.041877884F, -0.011073349F, 0.021454614F, 0.055855274F, 0.051702768F, 0.01894411F, -0.050590005F, -0.012410021F, -0.05905786F, 0.005044752F, 0.0078096963F, -0.015578682F, 0.027791934F, -0.029257525F, -0.03487562F, -0.020423273F, -0.02317804F, -0.023815842F, 0.02374799F, -0.015185144F, 0.018319879F, 0.013129246F, 0.05726658F, 0.022675939F, 0.021427473F, -0.004800487F, -0.00009334869F, 0.030695975F, -0.038078208F, -0.035581276F, 0.001702222F, 0.015334417F, 0.004559614F, -0.04651892F, -0.044293396F, 0.029881757F, -0.02906754F, 0.01308175F, -0.014357356F, -0.022323111F, 0.021468183F, -0.017994191F, 0.034224246F, 0.0072804554F, -0.028416166F, -0.012192897F, 0.014099522F, -0.0074772243F, 0.007049761F, -0.026231352F, -0.00038060395F, 0.016202915F, -0.010571249F, 0.040059466F, -0.013923108F, -0.005970923F, 0.0330572F, 0.009960586F, 0.0075179352F, 0.034169964F, 0.033654295F, -0.0048547676F, -0.020572545F, -0.02809048F, 0.012437162F, 0.036151227F, -0.0034722956F, -0.054281123F, 0.04396771F, 0.025091449F, -0.013217453F, -0.019554773F, -0.023368023F, 0.014750895F, 0.000115347386F, -0.02372085F, 0.0123896655F, -0.0083592925F, -0.011093704F, -0.0064458833F, 0.032188706F, 0.037996784F, 0.008210019F, -0.039462376F, 0.03297578F, 0.0018438619F, -0.032161564F, -0.0058352207F, 0.020206148F, 0.013468503F, 0.012871411F, 0.028117621F, -0.0035791614F, -0.022540236F, 0.0051634917F, 0.016230056F, 0.012145401F, -0.01499516F, -0.01686786F, -0.045677565F, -0.04358774F, -0.013122461F, -0.05381973F, 0.009322783F, 0.018062044F, 0.027900496F, -0.0061032334F, -0.017071413F, -0.008284656F, 0.012823915F, 0.00079174107F, -0.011622945F, 0.011731507F, -0.0055841706F, 0.017478522F, -0.00543829F, 0.022187408F, -0.015755095F, -0.014560911F, -0.005923427F, -0.04448338F, 0.022920204F, -0.01285784F, 0.0022815033F, 0.05471537F, -0.013074965F, -0.011941846F, -0.0014927308F, -0.009343138F, -0.011982557F, -0.008630699F, -0.04516189F, -0.004003233F, 0.050590005F, -0.03050599F, -0.022010995F, -0.028470447F, -0.003993055F, 0.025932806F, 0.009906305F, -0.008746046F, 0.001505453F, 0.041497916F, 0.014235224F, -0.016067212F, -0.04301779F, -0.028741853F, 0.040358014F, -0.013373511F, 0.016175775F, 0.011371895F, -0.018034903F, -0.0027089673F, -0.010211636F, 0.012789989F, -0.01796705F, 0.006975124F, -0.016800007F, 0.03373572F, -0.030858817F, 0.020626826F, -0.0057741543F, 0.011758648F, -0.0033009707F, 0.027819075F, 0.0015995968F, -0.009037807F, -0.009329568F, -0.023408733F, 0.047088873F, 0.02325946F, 0.029447509F, 0.014696614F, 0.019907601F, -0.004708887F, 0.016827147F, -0.003356948F, 0.015225855F, -0.016148634F, -0.040439434F, -0.0031092905F, 0.0058182576F, 0.017546372F, 0.011344754F, 0.02760195F, 0.024372224F, 0.016189344F, 0.0156193925F, 0.04453766F, 0.018794838F, 0.008379648F, 0.04206787F, 0.00020620466F, 0.0020677715F, 0.0027004858F, -0.029610353F, -0.014235224F, 0.030071741F, -0.009370279F, -0.018333448F, -0.029230384F, 0.018835548F, 0.011466887F, -0.022988055F, 0.04508047F, 0.008997096F, -0.008305011F, 0.0074500837F, 0.0015088456F, 0.005122781F, 0.018767698F, -0.03832247F, 0.025077878F, -0.00568934F, -0.017722785F, 0.007049761F, -0.03617837F, -0.15795806F, 0.0044408743F, 0.008338938F, -0.010388049F, 0.0061575146F, 0.018509863F, -0.021468183F, -0.0046037175F, 0.01746495F, -0.03235155F, -0.016243625F, 0.022105986F, -0.008589988F, -0.0620976F, 0.005736836F, -0.028877556F, -0.007178678F, -0.01017771F, 0.0061168037F, 0.002493539F, 0.014058811F, -0.02372085F, 0.06844849F, -0.0055706003F, -0.019907601F, 0.03400712F, 0.0069819093F, -0.0065748007F, 0.0049972557F, 0.009295642F, 0.0330572F, -0.003928596F, 0.012138615F, 0.012030054F, 0.0017336033F, -0.020206148F, -0.0028599366F, -0.03769824F, 0.04985721F, -0.055800993F, -0.019866891F, 0.027140561F, 0.025417134F, -0.011494027F, -0.026462046F, -0.039462376F, 0.004464622F, -0.0036639757F, 0.009010666F, -0.07355092F, 0.019961882F, 0.017139263F, 0.012152186F, -0.008148953F, -0.038023926F, -0.0015130863F, -0.008739261F, 0.029718913F, 0.022784501F, 0.00042046665F, -0.010924076F, 0.03240583F, -0.0026937006F, 0.009370279F, 0.036504053F, -0.021617457F, -0.0022662368F, -0.00016125309F, 0.0082032345F, -0.022173839F, -0.017342819F, -0.015388698F, -0.024725052F, 0.0155244F, 0.0026767377F, 0.028307606F, -0.030913098F, 0.023368023F, -0.007830052F, -0.021020364F, -0.0154836895F, 0.0045969323F, -0.0020270606F, -0.0004482433F, 0.006052345F, -0.005421327F, -0.051159956F, 0.04114509F, -0.020613255F, 0.019066244F, -0.030831676F, -0.029637491F, -0.017234256F, -0.02035542F, -0.005672377F, -0.031455908F, -0.037508253F, 0.019921172F, -0.007992895F, 0.002944751F, -0.029691773F, -0.04366916F, -0.026909865F, 0.024779331F, 0.002797174F, 0.039788064F, 0.025254292F, -0.022051705F, 0.05954639F, -0.0006501012F, 0.008135383F, -0.022906633F, 0.030885957F, 0.0060625225F, 0.014981589F, 0.061826196F, 0.026421336F, -0.013773834F, -0.026516328F, 0.0045630066F, 0.007816481F, 0.0052042026F, -0.020558974F, -0.02619064F, 0.007402588F, -0.022092417F, 0.03243297F, 0.036069807F, -0.012179326F, 0.0017573513F, -0.027724084F, -0.054932494F, -0.004267853F, 0.016772866F, 0.009899519F, 0.016854288F, -0.0007366118F, 0.0077622F, 0.025091449F, 0.025037168F, 0.001512238F, 0.011907921F, 0.026421336F, 0.06432313F, -0.025362855F, 0.0062389364F, -0.012036839F, 0.026434906F, 0.01595865F, 0.034604214F, 0.037915364F, -0.011860425F, 0.0036198723F, 0.044673365F, -0.003136431F, -0.030207444F, -0.012335385F, -0.0030567057F, -0.008793541F, 0.018279167F, -0.014085951F, -0.028361887F, -0.0060353824F, -0.014791606F, -0.007300811F, -0.022540236F, -0.037671097F, -0.024453646F, -0.016677875F, -0.0030448316F, 0.0028819882F, -0.005723266F, -0.030261725F, -0.008583202F, -0.010951216F, 0.02034185F, 0.007205819F, -0.020531835F, 0.006676578F, 0.0074907946F, -0.044429097F, 0.00048980233F, 0.019717617F, 0.021033935F, -0.022485955F, 0.012973188F, 0.030316006F, -0.00068233063F, 0.019473352F, -0.012186112F, -0.010605174F, -0.0034841695F, 0.005540067F, 0.013312445F, -0.028470447F, 0.0052109878F, -0.011276903F, 0.010116644F, -0.0042000017F, 0.04271924F, -0.012471087F, 0.0022831997F, -0.0031449124F, 0.0025393388F, -0.0039048481F, 0.0028514552F, -0.017125694F, -0.025892096F, 0.0070836865F, 0.00160723F, -0.03156447F, 0.007314381F, -0.08728404F, -0.0034604215F, 0.016827147F, 0.023856552F, 0.025837814F, -0.019989023F, 0.0024833614F, -0.00653409F, -0.04684461F, 0.03631407F, 0.038458176F, 0.05316836F, 0.013638131F, 0.018143464F, -0.006048952F, -0.0064458833F, -0.020966083F, -0.0005665592F, 0.007857192F, -0.0061676926F, 0.005414542F, -0.039923765F, -0.006937806F, 0.0044849776F, 0.027303403F, -0.006425528F, -0.0046613915F, -0.014425208F, -0.032080144F, -0.028497588F, 0.035988383F, -0.009024236F, -0.007857192F, 0.03389856F, -0.007307596F, -0.0189034F, -0.034034263F, -0.017179975F, 0.008074317F, 0.022024564F, -0.014425208F, 0.010354124F, -0.039733782F, -0.054471105F, 0.019866891F, 0.0046681766F, 0.044619083F, 0.0153072765F, 0.023951545F, 0.02179387F, 0.009600974F, 0.00076968933F, 0.0012959618F, -0.0030634908F, -0.003480777F, -0.026014227F, 0.0038912778F, -0.010143785F, 0.03240583F, 0.0042033945F, 0.010381265F, -0.018265598F, 0.011650085F, -0.024304371F, -0.03625979F, 0.04893443F, -0.024345083F, 0.012783204F, -0.016053641F, 0.04703459F, 0.035228446F, -0.017492091F, 0.053928293F, 0.005730051F, 0.011575449F, 0.009390634F, 0.011019068F, 0.02658418F, 0.021644598F, 0.029583212F, -0.017329248F, 0.032188706F, 0.017505663F, 0.006021812F, 0.056018118F, -0.0034264957F, 0.027018428F, 0.039163828F, 0.001035582F, 0.026000656F, 0.002279807F, 0.009207435F, 0.001660663F, 0.010157355F, -0.0029006475F, 0.040358014F, -0.024372224F, -0.008535706F, 0.03300292F, 0.014696614F, -0.013217453F, 0.017139263F, -0.015578682F, -0.024100818F, -0.017315678F, -0.04548758F, 0.0065612304F, -0.012179326F, 0.042257853F, 0.0037386122F, 0.016311478F, -0.009980941F, 0.021006795F, 0.0056621996F, 0.038892422F, 0.025824243F, -0.01981261F, -0.0310488F, 0.039299533F, -0.0044306964F, 0.01210469F, -0.009831668F, 0.03240583F, 0.05124138F, -0.009003881F, 0.023788702F, 0.0046138954F, 0.05042716F, 0.0062219733F, -0.029338947F, -0.00032441452F, 0.02330017F, -0.0155244F, 0.0029532323F, -0.006629082F, 0.011426176F, 0.014493059F, 0.0034977398F, 0.043804865F, 0.018618425F, -0.0016530298F, -0.005339905F, 0.0047394205F, 0.030288866F, -0.0031974972F, 0.010584818F, 0.03856674F, 0.010340554F, -0.005343298F, -0.044429097F, -0.028171903F, 0.004932797F, -0.016053641F, 0.0059607457F, 0.018306307F, -0.0019490315F, 0.011215837F, 0.0005644389F, -0.007097257F, 0.005736836F, 0.0021203563F, -0.02562069F, -0.0084475F, -0.014343786F, 0.0036979015F, -0.009790957F, -0.03134735F, -0.006381424F, -0.02083038F, 0.034685638F, -0.02035542F, -0.014655903F, 0.006669793F, -0.0266656F, 0.019894032F, -0.009227791F, -0.014465919F, -0.034549933F, 0.028117621F, 0.00035685598F, -0.021617457F, -0.0024596134F, -0.029637491F, -0.022825211F, -0.013421007F, 0.007918258F, 0.02471148F, -0.0063169654F, 0.0038912778F, 0.018808408F, -0.010639099F, -0.022920204F, 0.011120845F, -0.02273022F, 0.008216805F, -0.001023708F, 0.034767058F, 0.0095466925F, -0.0053534755F, -0.008522136F, -0.01235574F, -0.011120845F, -0.017600654F, 0.012450732F, -0.026733452F, 0.030668834F, 0.023693709F, -0.0042746384F, 0.029908897F, -0.009003881F, 0.025783533F, 0.0048106643F, 0.0024596134F, 0.0058250427F, 0.044429097F, -0.010625529F, 0.02078967F, 0.007952184F, 0.0006021812F, 0.035581276F, -0.03047885F, -0.0040676915F, 0.0011678922F, 0.007131182F, -0.017288538F, 0.0033874812F, 0.009499196F, 0.020097585F, 0.030777397F, 0.002379888F, 0.028497588F, 0.008929244F, 0.02806334F, -0.010225207F, -0.02709985F, 0.001416398F, 0.07745916F, 0.031320207F, -0.01235574F, -0.016325047F, 0.039408095F, 0.007355092F, -0.016270766F, 0.012430376F, -0.00062762544F, 0.021020364F, -0.0052788393F, 0.014452348F, -0.0058996794F, -0.009017452F, 0.011052993F, 0.019066244F, -0.003976092F, 0.036721177F, 0.0073347366F, 0.032188706F, 0.0075654313F, -0.007226174F, 0.013190312F, -0.034061402F, 0.013495644F, -0.010231991F, 0.0064832014F, -0.0019032318F, 0.038051065F, 0.0049836854F, -0.003088935F, -0.008718905F, 0.0054552527F, 0.027656231F, -0.015063011F, -0.020477554F, 0.03430567F, -0.0048513752F, 0.01788563F, 0.01595865F, -0.030071741F, 0.006968339F, -0.017695645F, 0.024806472F, -0.0154836895F, 0.038159627F, 0.012410021F, -0.007979325F, 0.0028107443F, -0.012240393F, -0.0015393787F, 0.017166404F, 0.03430567F, -0.02906754F, -0.013644917F, -0.0319173F, 0.03134735F, 0.022811642F, -0.01597222F, 0.006350891F, -0.036205508F, -0.014072381F, -0.01690857F, 0.0018710024F, -0.0026886119F, -0.015782235F, -0.01355671F, -0.011643301F, -0.018645566F, 0.02225526F, 0.01016414F, 0.0023764954F, -0.013468503F, -0.0029193065F, 0.013760264F, -0.014818746F, 0.010618744F, -0.01499516F, -0.039896622F, 0.0069954796F, -0.009852024F, 0.0012340473F, -0.0040778695F, 0.014085951F, -0.017627794F, -0.0013850167F, -0.0155244F, 0.0014978197F, -0.05759227F, 0.015280136F, -0.009132799F, 0.027900496F, -0.0026462045F, -0.0073279515F, -0.008413574F, -0.0053229425F, -0.02126463F, -0.009085302F, 0.015347987F, -0.006931021F, 0.028171903F, 0.010449116F, 0.015890798F, 0.060686294F, -0.027479818F, 0.010720521F, 0.02273022F, -0.0020355422F, 0.012912122F, -0.012776419F, 0.030967379F, 0.008277871F, 0.0048242346F, -0.008657839F, -0.035092745F, -0.008182879F, -0.019948311F, -0.021115357F, 0.0077214893F, -0.0035520208F, 0.004719065F, 0.0039048481F, 0.0064017796F, 0.037155427F, -0.0069819093F, 0.0060319896F, -0.0074840095F, 0.004301779F, -0.00014927308F, 0.007599357F, 0.0048581604F, 0.026326343F, -0.0103066275F, 0.012946048F, -0.008569632F, 0.020491123F, 0.03047885F, 0.020260429F, -0.011209051F, 0.037562534F, -0.057429425F, 0.009051377F, -0.019120526F, 0.01137868F, 0.0095670475F, -0.023313742F, -0.027221981F, -0.04119937F, -0.014927308F, 0.021237489F, 0.017084982F, 0.013570281F, 0.0045663994F, 0.0008583202F, 0.011806143F, -0.039055265F, 0.028741853F, -0.008766401F, 0.0064764163F, -0.016840719F, 0.00009849055F, -0.0031567866F, -0.00199992F, 0.004003233F, -0.019704048F, 0.017790638F, -0.0052856244F, 0.018089185F, 0.026475618F, 0.0047292425F, 0.024901465F, -0.017125694F, 0.0032890968F, 0.0023900657F, -0.01696285F, 0.0058996794F, -0.0048988713F, 0.0071108267F, -0.026326343F, 0.0068665617F, 0.026082078F, 0.0061643F, -0.016515031F, 0.035662696F, -0.0189034F, 0.002374799F, 0.00749758F, 0.003755575F, 0.029176103F, -0.016854288F, -0.03197158F, -0.009784172F, -0.009126013F, -0.023829412F, -0.009390634F, -0.005302587F, 0.03140163F, 0.0007166804F, 0.038892422F, -0.0032517784F, -0.0028667217F, 0.02468434F, -0.02224169F, -0.012572865F, -0.02762909F, 0.033762857F, 0.008210019F, 0.04304493F, -0.019554773F, -0.0030533131F, -0.045948967F, 0.018238457F, -0.003670761F, 0.033600014F, 0.032053F, 0.004047336F, 0.0034977398F, 0.028171903F, -0.036856882F, 0.0033281113F, -0.00847464F, 0.0035011324F, -0.014316645F, -0.033084344F, 0.031157363F, -0.0075247204F, 0.030316006F, -0.0127967745F, 0.009248146F, -0.015646534F, 0.015252995F, 0.020748958F, -0.014886597F, 0.029121822F, 0.029800335F, -0.025742821F, 0.025077878F, 0.0347942F, -0.005387401F, 0.023395164F, -0.0068292436F, -0.022105986F, -0.005580778F, 0.017817779F, -0.017125694F, 0.043994848F, -0.0104219755F, -0.0406837F, -0.011405821F, 0.012301459F, 0.007178678F, -0.0059030717F, 0.027181271F, -0.02370728F, 0.04206787F, -0.049015854F, -0.017654935F, -0.020735389F, 0.018062044F, -0.0060964483F, 0.01988046F, 0.0004469711F, -0.008508566F, -0.03617837F, 0.016610023F, -0.0151715735F, 0.0049904706F, 0.0013281911F, 0.005967531F, 0.012966403F, 0.008352508F, 0.010211636F, 0.07403945F, -0.006598549F, -0.015714385F, 0.013875612F, 0.0031618753F, -0.015877228F, 0.02567497F, 0.003857352F, -0.02330017F, 0.01937836F, 0.021495324F, -0.010686596F, 0.0010915594F, -0.0102862725F, -0.027140561F, -0.006839421F, 0.001207755F, 0.006439098F, 0.027683372F, -0.00254782F, -0.012179326F, -0.033138625F, 0.009587403F, 0.009078518F, 0.031184504F, -0.0120571945F, -0.0044714073F, -0.004708887F, -0.021481754F, 0.016610023F, 0.0086510535F, 0.03731827F, 0.018713417F, 0.04850018F, 0.030777397F, -0.0076197125F, -0.015144433F, -0.030397428F, -0.0156193925F, -0.0003218701F, 0.011609375F, -0.006724074F, 0.008440714F, -0.008311797F, -0.011270118F, 0.01650146F, 0.0140181F, 0.023571577F, 0.010856224F, 0.0084475F, 0.037861083F, -0.028524728F, -0.020843951F, 0.0097231055F, -0.021943143F, -0.03297578F, -0.0049836854F, -0.03237869F, 0.010354124F, 0.015402269F, -0.03634121F, -0.03335575F, -0.011270118F, 0.0038539595F, 0.01936479F, 0.0033365926F, 0.02080324F, -0.013685628F, 0.00016337345F, 0.0048479824F, -0.0035859465F, 0.025539268F, -0.007456869F, -0.013176742F, -0.009974156F, -0.011399035F, 0.0070429756F, -0.020531835F, 0.0023459622F, 0.017261397F, 0.017695645F, -0.0063305357F, -0.026502758F, -0.046681765F, -0.000541539F, -0.00044018598F, -0.017953482F, 0.015714385F, -0.016216485F, 0.0061100186F, 0.007972539F, 0.033464313F, -0.007802911F, 0.023449445F, 0.0017310589F, -0.048093073F, 0.023395164F, 0.023042336F, 0.00090496807F, -0.04755026F, 0.012165756F, -0.03870244F, 0.008060747F, -0.026041368F, 0.0018523432F, 0.011432962F, -0.0070022647F, -0.021413902F, -0.037589677F, 0.013488859F, 0.0061100186F,
                      -0.015158003F, 0.036639757F, -0.0041457205F, -0.0059030717F, -0.0033484667F, 0.025064308F);
              //List<Float> floatvector2 =  Arrays.asList(0.0014664384F, 0.05960067F,-0.061771914f);
              String id = parentId + "_" + chunks.indexOf(chunk);
              vectorDocument.removeField("id");
              vectorDocument.setField("id", id);
              vectorDocument.removeField("content_en");
              vectorDocument.removeField("content_fr");
            //  vectorDocument.removeField("exactContent");
              vectorDocument.addField("vector_1536", floatvector);
//              vectorDocument.addField("vector_4", floatvector2);
              //vectorDocument.addField(vectorField, floatvector);
              vectorDocument.addField("parent_doc", parentId);
            //  vectorDocument.addField("exactContent", chunk.text());
              vectorDocument.addField("content", chunk.text());

              // URL
              String url;
              if (parentDoc.containsKey("url")) {
                url = (String) parentDoc.getFieldValue("url");
                vectorDocument.addField("url", url);
              } else {
                url = (String) parentDoc.getFieldValue("id");
                vectorDocument.addField("url", url);
              }

              // TITLES
              if (parentDoc.getFieldValue("ignored_dc_title") != null) {
                parentDoc.getFieldValues("ignored_dc_title").forEach(value ->
                        vectorDocument.addField("title", value));
              }

              // keep the jsoup or filename as the first title for the searchView of Datafari
              String jsouptitle = "";
              String filename = "";
              if (parentDoc.getField("jsoup_title") != null) {
                jsouptitle = (String) parentDoc.getFieldValue("jsoup_title");
              }

              final SolrInputField streamNameField = parentDoc.get("ignored_stream_name");
              if (streamNameField != null && !streamNameField.getFirstValue().toString().isEmpty() && !streamNameField.getFirstValue().toString().toLowerCase().contentEquals("docname")) {
                filename = (String) streamNameField.getFirstValue();
              } else {
                final Pattern pattern = Pattern.compile("[^/]*$");
                final Matcher matcher = pattern.matcher(url);
                if (matcher.find()) {
                  filename = matcher.group();
                }
              }
              if (!jsouptitle.isEmpty()) {
                vectorDocument.addField("title", jsouptitle);
              } else if (!filename.isEmpty()) {
                vectorDocument.addField("title", filename);
              }
              // The title field has lost its original value(s) after the LangDetectLanguageIdentifierUpdateProcessorFactory
              // Need to set it back from the exactTitle field
              if (parentDoc.get("exactTitle") != null) {
                for (final Object value : parentDoc.getFieldValues("exactTitle")) {
                  vectorDocument.addField("title", value);
                }
              }

              try {
                client.add(vectorDocument);
                client.commit();
              } catch (SolrServerException e) {
                LOGGER.warn("Warning : the document associated to the chunk {} could not be added.", id);
              }
            }
          } else {
            LOGGER.warn("The file {} appears to be empty and has been ignored during vector embeddings.", parentDoc.get("id").getValue());
          }
        }

      }



      // VERY IMPORTANT ! without this line of code any other Update Processor declared AFTER this one in the conf WILL NOT EXECUTE
      super.processAdd(cmd);
    }
  }

  @Override
  public void processDelete(DeleteUpdateCommand cmd) throws IOException {
    final String id = cmd.getId();
    deleteExistingChildren(id);
    super.processDelete(cmd);
  }

  /**
   * Delete all the children of the parent document in VectorMain collection
   * @param parentId : The ID of the parent
   */
  private void deleteExistingChildren(String parentId) {
    try {
      client.deleteByQuery("parent_doc:\"" + parentId + "\"");
      client.commit();
    } catch (SolrServerException|IOException e) {
      LOGGER.error("Could not delete existing children for this document");
    }
  }

  /**
   *
   * @param content : The text content to embbed
   * @return The generated vector
   */
  private List<Float> vectorEmbeddings(String content) {
    // TODO : This method should be edited to implement the Solr Embeddings Model
/*
    SolrEmbeddingModel embedder = modelStore.getModel(embeddingModelName);
    float[] vectorToSearch = embedder.vectorise(qstr);*/


    /*
    List<Float> vector = new ArrayList<>();
    for (float f : vectorToSearch) {
      vector.add(f);
    }*/
    List<Float> vector = Arrays.asList(0.25f , -0.1F, 0.7F, -0.1f);

    return vector;
  }

}
